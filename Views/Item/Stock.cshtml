@model StockEditModel

@{
	ViewBag.Title = Resources.Resource.Stock;
	int rand = CommonHelper.GetVersionRandomNo();
	SessUser user = Model.User;
	var shop = user.shopCode ?? Model.ComInfo.Shop;
	var device = user.dvcCode ?? Model.ComInfo.Device;
}
<link rel="stylesheet" href="~/Content/item/stock.css?v=@rand" />
<h2>@ViewBag.Title</h2>

@using (Html.BeginForm("Stock", "Item", FormMethod.Get, new { @Id = "frmStock" }))
{
	@Html.Partial("_ItemPagesCheckBox", null, new ViewDataDictionary { { "stock", true } })

	<div class="form-inline my-4">
		<div class="form-group">
			<input type="text" class="form-control" id="txtKeyword" name="Keyword" placeholder="@Resources.Resource.EnterItemCodeName" />
			<button id="btnSearch" type="button" class="btn btn-primary ml-4">@Resources.Resource.Search</button>
			<button id="btnReload" type="button" class="btn btn-warning ml-4">@Resources.Resource.Reload</button>
			<a href="/Item/Edit?itemId=0&referrer=stock" role="button" class="btn btn-info ml-4">@string.Format(Resources.Resource.NewFormat, Resources.Resource.Item)</a>
		</div>
	</div>

	<div class="d-flex small">
		@Html.Partial("_ItemOptionsBlk", null, new ViewDataDictionary { { "showSaveBtn", true } })
	</div>

	<span class="font-weight-bold small">
		<span class="text-success">@Resources.Resource.LastUpdateTime:</span>
		<span id="lastupdatetime">@Model.LastUpdateTime</span>
		<span class="d-inline-block ml-4 mr-2 font-weight-bold">@Resources.Resource.Note:</span><span class="text-info">@Resources.Resource.AbssStockQtyNote</span>
	</span>

	<table id="tblStock" class="table table-bordered table-hover table-condensed">
		<thead class="gray-header">
			<tr class="">
				<th><input id="chkall" type="checkbox" class="form-check" /></th>
				<th class="text-left colheader" data-col="0">@Resources.Resource.ItemCode <span class="small font-weight-bold"></span></th>
				<th class="text-left colheader" data-col="1">@Resources.Resource.ItemName</th>
				<th class="text-center">@Resources.Resource.Batch|@Resources.Resource.SerialNo|@Resources.Resource.ExpiryDate</th>
				<th class="text-center">@Resources.Resource.ItemVariations</th>

				<th class="text-right">@Resources.Resource.OnHandStock</th>
				@foreach (var _shop in Model.ShopNames)
				{
					<th class="text-right">@_shop.Trim()</th>
				}
				<th></th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in Model.PagingItemList)
						{
							var itemcode = item.itmCode;
							var trcls = Model.EnableBuySellUnits ? "button" : "";
							var ondblclick = Model.EnableBuySellUnits ? $"HandleStockDblClick(\"{itemcode}\");" : "";
							var itemoption = Model.DicItemOptions[itemcode];
							var fabatcls = itemoption != null ? itemoption.ChkBatch ? "check-square" : "square-o" : "square-o";
							var fasncls = itemoption != null ? itemoption.ChkSN ? "check-square" : "square-o" : "square-o";
							var favtcls = itemoption != null ? itemoption.WillExpire ? "check-square" : "square-o" : "square-o";
							var facls = item.hasItemVari ? "check" : "xmark";
							var displaycls = item.hasItemVari ? "text-success" : "text-danger";
							var onhandstock = item.OnHandStock <= 0 ? Html.Raw($"<span class=\"outofstock\">{item.OnHandStock}</span>"): Html.Raw(item.OnHandStock.ToString());
							var diclocqty = Model.DicItemLocQty[itemcode];
							var dicabssqty = Model.DicItemAbssQty[itemcode];

							foreach(var e in Model.Shops)
							{
								var locqty = diclocqty[e];
								var abssqty = dicabssqty[e];
								var locqtydisplay = "";
								var isprimary = Model.PrimaryLocation == e ? 1 : 0;

								if (locqty <= 0)
								{
									locqtydisplay = `
< span class="danger">${locqty
				}</span>`;
} else
			{
				locqtydisplay = `
< span >${ locqty}</ span >`;
			}

			var readonly =
			itemoption?.ChkBatch ||
			itemoption?.ChkSN ||
			itemoption?.WillExpire ||
			(itemcode in DicIvInfo && DicIvInfo[itemcode].length > 0)
? "readonly"
: "";

			var inputcls =
			!itemoption?.ChkBatch && !itemoption?.ChkSN && !itemoption?.WillExpire
			? "locqty"
			: "locqty itemoption";
			if (
			itemcode in DicIvInfo &&
			DicIvInfo[itemcode].length > 0 &&
			!itemoption?.ChkBatch &&
			!itemoption?.ChkSN &&
			!itemoption?.WillExpire
)
inputcls = "locqty vari";

			var _html = forstock
			? `${locqtydisplay}`
: `
< input type = "text" class= "text-right form-control btnsmall ${inputcls}" data - isprimary = "${isprimary}" data - code = "${item.itmCode}" data - shop = "${e}" data - onhandstock = "${item.OnHandStock}" data - id = "${Id}" data - oldval = "${locqty}" data - abssqty = "${abssqty}" data - itemid = "${item.itmItemID}" value = "${locqty}" ${ readonly}
			title = "${transferdblclickhints}" />`;

			html += `
< td class= "text-right locqty" >${ _html}</ td >`;
				}


				<tr class="@trcls" data-code="@itemcode" data-jsstocklist="@item.JsonJsStockList" ondblclick="@ondblclick">
					<td><input type="checkbox" class="form-check chk" data-id="@item.itmItemID" data-code="@itemcode"></td>

					<td class="text-left">@itemcode</td>`;

					<td class="text-left itemdesc" data-desc="@item.NameDesc" title="@item.NameDesc">@item.NameDescDisplay</td>
					<td class="text-center"><span class="text-success"><span class="fa fa-@fabatcls"></span> <span class="fa fa-@fasncls"></span> <span class="fa fa-@favtcls"></span></span></td>

					<td class="text-center"><span class="fa fa-@facls @displaycls"></span></td>

					<td class="text-right locqty">@onhandstock</td>

					

					

					

				</tr>
			}

			
		</tbody>

	</table>

	<div class="Pager my-3"></div>

	@Html.Partial("_SortOrderNameHidden")
}
@Html.Partial("_NoRecordFound")
@Html.Partial("_WaitingModal")
@Html.Partial("_DescModal")
@Html.AntiForgeryToken()
<div id="infoblk" data-shop="@user.shopCode" data-shops="@string.Join(",",Model.Shops)" data-enablebuysellunits="@Model.EnableBuySellUnits" data-idlist="@string.Join(",",Model.ItemIdList)" data-jsondiciditemoptions="@JsonSerializer.Serialize(Model.DicIDItemOptions)" data-referrer="stock"></div>

<script src="~/Scripts/ASPSnippets_Pager.min.js"></script>
<script src="~/Scripts/ts/js/item/stock.js?v=@rand"></script>

